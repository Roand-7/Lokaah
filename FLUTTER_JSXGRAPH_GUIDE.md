# ðŸ“± FLUTTER JSXGRAPH INTEGRATION - Complete Guide

## âœ… What Was Created

### 1. Files Added
- **assets/jsxgraph_template.html** - WebView template with JSXGraph engine
- **lib/widgets/jsxgraph_viewer.dart** - Flutter widget for rendering graphs
- **lib/screens/question_screen.dart** - Example question screen with integration
- **lib/models/generated_question.dart** - Question model with JSXGraph fields
- **pubspec.yaml** - Updated with WebView dependencies and assets

### 2. Features Implemented
âœ… **Interactive Geometry Rendering**
   - AI-generated JSXGraph code from backend renders in mobile app
   - Touch-optimized controls (pan, zoom, drag)
   - Real-time interaction tracking

âœ… **VEDA Teaching Integration**
   - Highlight elements for hints
   - Add text annotations dynamically
   - Update graph based on student progress

âœ… **Answer Extraction**
   - Extract graph state (point positions, line properties)
   - Support for "drag the point to answer" questions
   - Send graph state to backend for verification

âœ… **Error Handling**
   - Graceful fallback for CDN failures
   - User-friendly error messages
   - Retry mechanism

---

## ðŸ“‹ Installation Steps

### Step 1: Install Flutter Dependencies

```bash
cd c:\Users\Lenovo\lokaah_app
flutter pub get
```

This will install:
- `webview_flutter: ^4.4.2`
- `webview_flutter_wkwebview: ^3.9.4` (iOS)
- `webview_flutter_android: ^3.12.0` (Android)

### Step 2: Verify Assets

Ensure `assets/jsxgraph_template.html` exists and is referenced in `pubspec.yaml`:

```yaml
flutter:
  assets:
    - assets/jsxgraph_template.html
```

### Step 3: Platform-Specific Configuration

#### Android (android/app/src/main/AndroidManifest.xml)
Add internet permission:

```xml
<manifest>
    <uses-permission android:name="android.permission.INTERNET" />
    
    <application
        android:usesCleartextTraffic="true">
        <!-- Your existing config -->
    </application>
</manifest>
```

#### iOS (ios/Runner/Info.plist)
Add WebView configuration:

```xml
<key>io.flutter.embedded_views_preview</key>
<true/>
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSAllowsArbitraryLoads</key>
    <true/>
</dict>
```

---

## ðŸŽ¯ Usage Examples

### Example 1: Simple Trigonometry Question with Visualization

```dart
import 'package:flutter/material.dart';
import 'models/generated_question.dart';
import 'screens/question_screen.dart';

void main() {
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'LOKAAH Practice',
      home: QuestionListScreen(),
    );
  }
}

class QuestionListScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    // This would come from your API call to backend
    final question = GeneratedQuestion(
      id: 'AI_12345_1739520000',
      text: 'Priya is flying a kite at India Gate. The string is 50m long and makes 60Â° with the ground. Find the height of the kite. (Use âˆš3 = 1.73)',
      difficulty: 'medium',
      marks: 3,
      concept: 'trigonometry_heights',
      source: 'ai',
      conceptTags: ['trigonometry', 'heights', 'sin'],
      
      // JSXGraph code generated by True AI Oracle
      jsxGraphCode: '''
        // Create triangle representing kite problem
        var ground = board.create('line', [[0,0], [10,0]], {
          straightFirst: false,
          straightLast: false,
          strokeColor: '#8B4513',
          strokeWidth: 3,
          name: 'Ground'
        });
        
        var base = board.create('point', [0, 0], {
          name: 'Observer',
          fixed: true,
          size: 4,
          fillColor: '#2c3e50'
        });
        
        var kite = board.create('point', [5, 4.33], {
          name: 'Kite',
          fixed: true,
          size: 4,
          fillColor: '#e74c3c'
        });
        
        var string = board.create('line', [base, kite], {
          straightFirst: false,
          straightLast: false,
          strokeColor: '#3498db',
          strokeWidth: 2,
          dash: 2
        });
        
        // Show angle
        var angle = board.create('angle', [
          [10, 0], 
          base, 
          kite
        ], {
          type: 'sector',
          orthoType: 'square',
          radius: 1.5,
          fillColor: '#f39c12',
          strokeColor: '#f39c12'
        });
        
        board.create('text', [1.8, 0.3, '60Â°'], {
          fontSize: 16,
          strokeColor: '#f39c12'
        });
        
        // Height line (dashed)
        board.create('line', [[5,0], [5,4.33]], {
          straightFirst: false,
          straightLast: false,
          dash: 1,
          strokeColor: '#27ae60',
          strokeWidth: 2
        });
        
        board.create('text', [5.3, 2, 'h = ?'], {
          fontSize: 14,
          strokeColor: '#27ae60'
        });
        
        // String length label
        board.create('text', [2.3, 2.5, '50m'], {
          fontSize: 14,
          strokeColor: '#3498db'
        });
      ''',
      
      graphBoundingBox: [-1, 6, 11, -1],
      showAxis: true,
      showGrid: true,
      requiresGraphInteraction: false,
      answerType: 'numeric',
      correctAnswer: 43.30,
      solutionSteps: [
        'Given: String length (hypotenuse) = 50m',
        'Angle with ground = 60Â°',
        'We need to find height (opposite side)',
        'Using sin Î¸ = opposite/hypotenuse',
        'sin 60Â° = height / 50',
        'height = 50 Ã— sin(60Â°)',
        'height = 50 Ã— 0.866',
        'height = 43.30m',
      ],
      finalAnswer: '43.30m',
      socraticHints: [
        {
          'level': '1',
          'hint': 'Think about which trigonometric ratio relates the angle, the string length, and the height',
          'nudge': 'Which sides of the triangle do you know?'
        },
        {
          'level': '2',
          'hint': 'The height is opposite to the 60Â° angle, and the string is the hypotenuse',
          'nudge': 'Which trig ratio uses opposite and hypotenuse?'
        },
        {
          'level': '3',
          'hint': 'Use sin 60Â° = height / 50',
          'nudge': 'Multiply both sides by 50 to isolate height'
        },
      ],
    );

    return Scaffold(
      appBar: AppBar(title: Text('Practice Questions')),
      body: ListView(
        padding: EdgeInsets.all(16),
        children: [
          QuestionCard(
            question: question,
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => QuestionScreen(question: question),
                ),
              );
            },
          ),
        ],
      ),
    );
  }
}

class QuestionCard extends StatelessWidget {
  final GeneratedQuestion question;
  final VoidCallback onTap;

  const QuestionCard({required this.question, required this.onTap});

  @override
  Widget build(BuildContext context) {
    return Card(
      child: ListTile(
        title: Text(question.text),
        subtitle: Text('${question.marks} marks â€¢ ${question.source.toUpperCase()}'),
        trailing: question.jsxGraphCode != null
            ? Icon(Icons.visibility, color: Colors.blue)
            : null,
        onTap: onTap,
      ),
    );
  }
}
```

---

### Example 2: Fetching Questions from Backend

```dart
import 'dart:convert';
import 'package:http/http.dart' as http;

class QuestionService {
  final String baseUrl = 'http://your-backend-url.com/api/v1';

  Future<GeneratedQuestion> fetchQuestion({
    required String concept,
    int marks = 3,
    double difficulty = 0.6,
    String? forceSource, // 'pattern', 'ai', or null
  }) async {
    final response = await http.post(
      Uri.parse('$baseUrl/question/generate'),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({
        'concept': concept,
        'marks': marks,
        'difficulty': difficulty,
        'force_source': forceSource,
      }),
    );

    if (response.statusCode == 200) {
      final data = jsonDecode(response.body);
      return GeneratedQuestion.fromJson(data);
    } else {
      throw Exception('Failed to generate question');
    }
  }

  Future<Map<String, dynamic>> submitAnswer({
    required String questionId,
    required String studentId,
    String? textAnswer,
    Map<String, dynamic>? graphState,
    required int timeTaken,
  }) async {
    final response = await http.post(
      Uri.parse('$baseUrl/attempt/submit'),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({
        'question_id': questionId,
        'student_id': studentId,
        'answer': textAnswer ?? '',
        'graph_state': graphState,
        'time_taken_seconds': timeTaken,
      }),
    );

    if (response.statusCode == 200) {
      return jsonDecode(response.body);
    } else {
      throw Exception('Failed to submit answer');
    }
  }
}

// Usage
void main() async {
  final service = QuestionService();
  
  // Fetch AI-generated question
  final question = await service.fetchQuestion(
    concept: 'trigonometry_heights',
    marks: 3,
    difficulty: 0.6,
    forceSource: 'ai',  // Force AI Oracle for visualization
  );
  
  print('Question: ${question.text}');
  print('Has visualization: ${question.jsxGraphCode != null}');
}
```

---

### Example 3: VEDA Hint Integration

```dart
class QuestionScreenWithVeda extends StatefulWidget {
  final GeneratedQuestion question;
  
  @override
  _QuestionScreenWithVedaState createState() => _QuestionScreenWithVedaState();
}

class _QuestionScreenWithVedaState extends State<QuestionScreenWithVeda> {
  final GlobalKey<JSXGraphViewerState> _graphKey = GlobalKey();
  int _hintLevel = 0;

  void _showNextHint() {
    if (_hintLevel >= widget.question.socraticHints.length) {
      _showSnackBar('No more hints available!');
      return;
    }

    final hint = widget.question.socraticHints[_hintLevel];
    
    // Show text hint
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Hint ${_hintLevel + 1}/3'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              hint['hint'] ?? '',
              style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 8),
            Text(
              hint['nudge'] ?? '',
              style: TextStyle(fontSize: 14, color: Colors.grey[700]),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('Got it!'),
          ),
        ],
      ),
    );

    // Visual hint on graph (if applicable)
    if (_hintLevel == 0) {
      // First hint: Highlight the angle
      _graphKey.currentState?.addAnnotation(
        1.5, 0.5,
        'This angle is key!',
        color: Colors.orange,
      );
    } else if (_hintLevel == 1) {
      // Second hint: Highlight height line
      _graphKey.currentState?.addAnnotation(
        5.5, 2,
        'Find this height',
        color: Colors.green,
      );
    } else if (_hintLevel == 2) {
      // Third hint: Show formula
      _graphKey.currentState?.addAnnotation(
        3, 5,
        'sin 60Â° = h/50',
        color: Colors.red,
      );
    }

    setState(() {
      _hintLevel++;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('VEDA Teaching Mode'),
        actions: [
          IconButton(
            icon: Icon(Icons.lightbulb_outline),
            onPressed: _showNextHint,
            tooltip: 'Get hint ($_hintLevel/3 used)',
          ),
        ],
      ),
      body: Column(
        children: [
          // Question and graph...
          Expanded(
            child: JSXGraphViewer(
              key: _graphKey,
              jsxCode: widget.question.jsxGraphCode,
              // ... other properties
            ),
          ),
        ],
      ),
    );
  }

  void _showSnackBar(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(message)),
    );
  }
}
```

---

## ðŸ”§ Troubleshooting

### Issue 1: Graph Not Rendering
**Symptoms:** Blank white screen or "Loading..." forever

**Solutions:**
1. Check internet connection (JSXGraph loads from CDN)
2. Verify `assets/jsxgraph_template.html` is in assets folder
3. Run `flutter pub get` to refresh assets
4. Check browser console in debug mode: `flutter run --web-renderer html`

### Issue 2: JavaScript Errors
**Symptoms:** Red error box in WebView

**Solutions:**
1. Validate JSXGraph code syntax from backend
2. Check browser console for specific error
3. Test JSX code in standalone HTML file first
4. Ensure `board` variable is used correctly

### Issue 3: Touch Interactions Not Working
**Symptoms:** Can't drag points or interact with graph

**Solutions:**
1. Check `touch-action: none` in CSS (already in template)
2. Verify `pan` and `zoom` settings in `initBoard()`
3. Test on physical device (emulator may have issues)

### Issue 4: Graph State Extraction Fails
**Symptoms:** `getGraphState()` returns null

**Solutions:**
1. Ensure graph is ready (`_isReady == true`)
2. Check object IDs match in JSX code
3. Use `board.objects` in browser console to debug

---

## ðŸ“Š Performance Optimization

### 1. Preload HTML Template
```dart
// In app initialization
void initState() {
  super.initState();
  rootBundle.loadString('assets/jsxgraph_template.html');
}
```

### 2. Cache API Responses
```dart
// Use dio with cache interceptor
final dio = Dio()
  ..interceptors.add(DioCacheInterceptor(options: CacheOptions()));
```

### 3. Optimize Graph Complexity
- Limit number of elements in JSXGraph code
- Use `fixed: true` for non-interactive elements
- Avoid heavy animations

---

## ðŸŽ“ Best Practices

### 1. Error Boundaries
Always wrap JSXGraphViewer in error handling:
```dart
if (question.jsxGraphCode != null)
  try {
    JSXGraphViewer(...)
  } catch (e) {
    ErrorWidget(error: e);
  }
```

### 2. Loading States
Show loading indicator while graph initializes:
```dart
Stack(
  children: [
    JSXGraphViewer(...),
    if (!_isReady)
      Center(child: CircularProgressIndicator()),
  ],
)
```

### 3. Accessibility
Add semantic labels for screen readers:
```dart
Semantics(
  label: 'Interactive geometry diagram',
  child: JSXGraphViewer(...),
)
```

---

## ðŸš€ Next Steps

1. **Run Flutter App:**
   ```bash
   flutter run
   ```

2. **Test Question Screen:**
   - Generate question from backend API
   - Verify graph renders correctly
   - Test interaction tracking
   - Submit answer and verify backend receives graph state

3. **Integrate with VEDA:**
   - Connect hint system
   - Implement adaptive difficulty
   - Add real-time feedback

4. **Production Deployment:**
   - Test on multiple devices (iOS/Android)
   - Optimize graph loading performance
   - Add offline support (download JSXGraph locally)

---

**Status:** âœ… READY FOR INTEGRATION  
**Last Updated:** February 14, 2026  
**Version:** 1.0.0
